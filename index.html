<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>TREDIO â€” Mobile Ready</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{ --bg:#0b0b0c; --panel:#111217; --muted:#9aa0a6; --green:#2ecc71; --red:#e74c3c; --accent:#f1c40f; }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Arial,Helvetica,sans-serif;-webkit-font-smoothing:antialiased;}
  body{display:flex;flex-direction:column;min-height:100vh;}

  /* Login full-screen */
  #loginScreen{ display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; padding:20px; box-sizing:border-box; }
  #loginBox{ width:100%; max-width:520px; background:#111217; padding:24px; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,0.6); }
  #loginBox h1{ text-align:center; font-size:36px; margin:0 0 12px 0; letter-spacing:1px; }
  .input{ width:100%; padding:14px; border-radius:12px; border:1px solid #1a1a1a; background:#0b0b0b; color:#fff; margin-bottom:12px; font-size:16px; box-sizing:border-box; }

  .btn-primary{ width:100%; padding:12px; border-radius:12px; border:none; background:var(--green); color:#fff; font-weight:800; font-size:16px; cursor:pointer; }
  .btn-primary:disabled{ background:#1e5e3b; cursor:not-allowed; }
  .btn-secondary{ width:100%; padding:12px; border-radius:12px; border:none; background:#3498db; color:#fff; font-weight:700; font-size:15px; cursor:pointer; margin-top:8px; }
  .btn-secondary:disabled{ background:#1c537d; cursor:not-allowed; }

  /* Register popup overlay */
  #registerPopup{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.72); justify-content:center; align-items:center; padding:18px; z-index:9999; box-sizing:border-box; }
  #registerInner{ width:100%; max-width:520px; background:#111217; padding:18px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.6); }

  /* Main app layout - mobile-first single column */
  .app { display:flex; flex-direction:column; width:100%; box-sizing:border-box; padding:12px; gap:10px; padding-bottom:calc(16px + env(safe-area-inset-bottom)); }
  .panel { background:linear-gradient(180deg,#070708 0%, var(--panel) 100%); border-radius:12px; padding:10px; box-shadow:0 8px 30px rgba(0,0,0,0.6); }
  .header{ display:flex; justify-content:space-between; align-items:center; gap:8px; padding:6px 0; }
  .header .left{ display:flex; flex-direction:column; gap:4px; }
  .hdr-title{ font-size:14px; color:#ddd; }
  .hdr-links a{ color:#e74c3c; font-weight:700; text-decoration:none; font-size:13px; }
  .saldo { font-weight:800; color:var(--green); font-size:16px; }

  /* Chart area big: ~90% height feel - use vh */
  .chart-wrap{ position:relative; background:#000; border-radius:12px; padding:8px; overflow:hidden; }
  canvas{ width:100% !important; height:calc(62vh) !important; display:block; border-radius:8px; } /* large on mobile */

  /* timeline beneath chart */
  #timeLine{ display:flex; justify-content:space-between; margin-top:8px; font-size:13px; color:#ff4444; font-weight:bold; padding:0 6px; }
  #timeLine span{ flex:1; text-align:center; opacity:0.85; }

  /* Controls sticky bottom area */
  .controls-area { position:sticky; bottom:12px; z-index:40; width:100%; }
  .card{ background:#0f1113; padding:12px; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.45); }

  .top-controls { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
  .icon-btn { background:#222; border:1px solid #222; color:#fff; padding:10px; border-radius:10px; cursor:pointer; font-size:18px; min-width:48px; display:inline-flex; align-items:center; justify-content:center; }
  .select-interval{ padding:10px; border-radius:10px; background:#0b0b0b; color:#fff; border:1px solid #222; min-width:120px; }

  .small-muted{ color:#9aa0a6; font-size:13px; }
  .quick-select{ width:100%; padding:12px; border-radius:10px; background:#0b0b0b; color:#fff; border:1px solid #222; margin-top:6px; box-sizing:border-box; }

  .amount-input{ width:100%; padding:12px; border-radius:10px; border:1px solid #222; background:#0b0b0b; color:#fff; margin-top:8px; box-sizing:border-box; }

  .btn-row{ display:flex; gap:10px; margin-top:12px; }
  .btn-up{ background:linear-gradient(135deg,var(--green),#27ae60); color:#fff; }
  .btn-down{ background:linear-gradient(135deg,var(--red),#c0392b); color:#fff; }
  .btn{ flex:1; padding:14px; border-radius:12px; border:none; font-weight:800; font-size:16px; cursor:pointer; }
  .btn:disabled{ opacity:0.6; cursor:not-allowed; }

  .status { margin-top:12px; padding:12px; border-radius:10px; background:#070708; text-align:center; font-weight:700; font-size:15px; }
  .result-win{ color:var(--green); }
  .result-lose{ color:var(--red); }
  .error-box{ margin-top:10px; color:#e74c3c; font-size:14px; padding:8px; border:1px solid var(--red); border-radius:6px; background:rgba(231,76,60,0.1); word-break: break-word; }

  /* responsive for wider screens: two-column */
  @media (min-width:900px){
    .app{ max-width:980px; margin:12px auto; display:grid; grid-template-columns: 1fr 360px; gap:12px; padding:12px; }
    canvas{ height:360px !important; }
    .controls-area{ position:static; }
  }
</style>
</head>
<body>

<!-- LAYAR LOGIN (full-screen) -->
<div id="loginScreen">
  <div id="loginBox">
    <h1>TREDIO</h1>
    <div style="color:var(--muted); text-align:center; margin-bottom:12px;">Masuk untuk mulai trading</div>

    <input id="loginUser" class="input" placeholder="Username" autocomplete="username" />
    <input id="loginPass" class="input" placeholder="Password" type="password" autocomplete="current-password" />
    <button id="btnLogin" class="btn-primary">LOGIN</button>

    <button id="btnOpenRegister" class="btn-secondary">REGISTER</button>

    <div id="loginError" class="error-box" style="display:none;"></div>
  </div>
</div>

<!-- POPUP REGISTER -->
<div id="registerPopup">
  <div id="registerInner">
    <h2 style="margin:0 0 12px 0">Register Akun Baru</h2>
    <input id="regUser" class="input" placeholder="Username" />
    <input id="regPass" class="input" placeholder="Password" type="password" />
    <input id="regEmail" class="input" placeholder="Email (Opsional)" type="email" />
    <input id="regHp" class="input" placeholder="Nomor HP (Opsional)" />
    <input id="regBank" class="input" placeholder="Bank (Opsional)" />
    <input id="regNorek" class="input" placeholder="No Rekening (Opsional)" />
    <button id="btnRegister" class="btn-primary" style="margin-top:6px">DAFTAR</button>
    <button id="btnRegCancel" class="btn-secondary" style="margin-top:8px">BATAL</button>
    <div id="regError" class="error-box" style="display:none;"></div>
  </div>
</div>

<!-- APLIKASI UTAMA -->
<div id="mainApp" class="app" style="display:none;">

  <!-- Panel Atas: header + chart besar -->
  <div class="panel" style="padding:12px;">
    <div class="header">
      <div class="left">
        <div class="hdr-title">Harga Batubara Premium</div>
        <div class="hdr-links"><a href="https://wa.me/message/HWGD7LUY5VQIF1" target="_blank">Deposit / Withdraw</a></div>
      </div>

      <div style="text-align:right">
        <div style="font-size:12px;color:#9aa0a6">Saldo Real:</div>
        <div class="saldo" id="saldoText">Rp 0</div>
      </div>
    </div>

    <div class="chart-wrap" id="chartWrap">
      <canvas id="chartCanvas"></canvas>
      <div id="overlayOpen" class="overlay-line overlay-open"></div>
      <div id="overlayClose" class="overlay-line overlay-close"></div>
    </div>

    <div id="timeLine" style="margin-top:10px;"></div>

    <div style="display:flex;justify-content:space-between;margin-top:10px;color:#9aa0a6;">
      <div>Harga Buka: <span id="txtOpen">-</span></div>
      <div>Harga Sekarang: <span id="txtNow">-</span></div>
      <div>Countdown: <span id="txtCountdown">Durasi taruhan</span>s</div>
    </div>
  </div>

  <!-- Bawah: kontrol lengket -->
  <div class="controls-area">
    <div class="card">
      <div class="top-controls">
        <button id="soundToggle" class="icon-btn">ðŸ”‡</button>
        <select id="intervalSelect" class="select-interval">
          <option value="1">1 menit</option>
          <option value="5" selected>5 menit</option>
          <option value="10">10 menit</option>
          <option value="20">20 menit</option>
        </select>
        <div style="flex:1; text-align:right; color:#9aa0a6; font-size:13px;">Durasi taruhan</div>
      </div>

      <div class="small-muted">Pilih Nominal Cepat</div>
      <select id="quickAmount" class="quick-select">
        <option value="">Pilih Nominal Cepat</option>
        <option value="140000">140.000</option>
        <option value="240000">240.000</option>
        <option value="700000">700.000</option>
        <option value="1400000">1.400.000</option>
        <option value="14000000">14.000.000</option>
        <option value="30000000">30.000.000</option>
        <option value="74000000">74.000.000</option>
      </select>

      <input id="manualAmount" class="amount-input" type="number" placeholder="Atau masukkan manual (Rp)" />

      <div class="btn-row">
        <button id="btnUp" class="btn btn-up">â¬† PASANG NAIK</button>
        <button id="btnDown" class="btn btn-down">â¬‡ PASANG TURUN</button>
      </div>

      <div class="status" id="statusBox">Menunggu transaksi...</div>

      <div class="small-muted" style="margin-top:10px">
        <div>Hasil terakhir: <span id="lastResult">-</span></div>
        <div>Harga Tutup (last): <span id="txtClose">-</span></div>
      </div>
    </div>
  </div>

</div>

<script>
/* ============================
   KONFIGURASI: API endpoint (Apps Script WebApp)
   DITETapkan ke URL yang Anda berikan
   ============================ */
const API = "https://script.google.com/macros/s/AKfycbw093Eov9Z5ZMOKwDMSd19CvrAB4GDRQHTaeBpkQUq36NiwlgstE29Hu81unj5ta_I/exec";

/* Helper: POST JSON ke API dengan retry (Exponential Backoff) */
async function apiPost(body){
  let attempt = 0;
  const maxAttempts = 3;
  
  while (attempt < maxAttempts) {
    try{
      const res = await fetch(API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
        mode: 'cors'
      });

      if (!res.ok) {
        throw new Error(`Status HTTP ${res.status}: ${res.statusText}. Mungkin Apps Script Anda gagal dalam eksekusi (Internal Server Error)`);
      }

      const text = await res.text();
      if (!text || !text.startsWith('{')) {
          throw new Error('Respons bukan JSON yang valid. Pastikan Apps Script Anda mengembalikan JSON dan tidak ada Error di Code.gs.');
      }
      
      const result = JSON.parse(text);
      return result;

    }catch(e){
      console.error(`apiPost attempt ${attempt + 1} failed:`, e.message);
      if (attempt === maxAttempts - 1) {
        throw new Error(`Koneksi Gagal ke API setelah ${maxAttempts} percobaan. KEMUNGKINAN TERBESAR: Izin Web App Apps Script BUKAN 'Anyone' atau URL SALAH. Error Asli: ${e.message}`);
      }
      await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempt)));
      attempt++;
    }
  }
}

window.addEventListener('DOMContentLoaded', ()=>{

  // DOM refs
  const loginScreen = document.getElementById('loginScreen');
  const mainApp = document.getElementById('mainApp');
  const btnLogin = document.getElementById('btnLogin');
  const btnOpenRegister = document.getElementById('btnOpenRegister');
  const registerPopup = document.getElementById('registerPopup');
  const btnRegister = document.getElementById('btnRegister');
  const btnRegCancel = document.getElementById('btnRegCancel');
  const regError = document.getElementById('regError');

  const btnUp = document.getElementById('btnUp');
  const btnDown = document.getElementById('btnDown');
  const quickAmount = document.getElementById('quickAmount');
  const manualAmount = document.getElementById('manualAmount');
  const saldoText = document.getElementById('saldoText');
  const lastResult = document.getElementById('lastResult');
  const txtNow = document.getElementById('txtNow');
  const txtOpen = document.getElementById('txtOpen');
  const txtClose = document.getElementById('txtClose');
  const txtCountdown = document.getElementById('txtCountdown');
  const statusBox = document.getElementById('statusBox');
  const intervalSelect = document.getElementById('intervalSelect');
  const soundToggle = document.getElementById('soundToggle');
  const loginError = document.getElementById('loginError');
  const loginUserInput = document.getElementById('loginUser');
  const loginPassInput = document.getElementById('loginPass');

  // app state
  let currentUser = null;
  let saldo = 0; // Saldo awal harus 0, akan diupdate dari API
  const formatIDR = v => 'Rp ' + Number(v).toLocaleString('id-ID', {minimumFractionDigits: 0, maximumFractionDigits: 0});

  // polling
  let pollIntervalId = null;
  const POLL_INTERVAL_MS = 3000;

  // init display
  saldoText.textContent = formatIDR(saldo);

  /* ---------------- SETUP CHART (tidak berubah) ---------------- */
  const hargaPerMenit = [74.996,75.001,74.998,75.005,75.012,75.008,75.004,74.999,75.003,75.008,75.015,75.020,75.025,75.022,75.018,75.014,75.010,75.006,75.009,75.014,75.011,75.005,75.000,74.995,74.990,74.987,74.982,74.979,74.975,74.970,74.965,74.968,74.972,74.977,74.981,74.985,74.990,74.985,74.980,74.976,74.972,74.978,74.983,74.975,74.970,74.965,74.971,74.977,74.980,74.985,74.992,74.996,75.000,75.005,75.011,75.018,75.023,75.028,75.025,75.021];

  const ctx = document.getElementById('chartCanvas').getContext('2d');
  const customOverlayPlugin = {
    id:'customOverlay',
    afterDraw(chart,args,options){
      const {ctx, chartArea, scales} = chart;
      const o = options.openIndex;
      const c = options.closeIndex;
      function X(i){ return i==null?null:scales.x.getPixelForValue(chart.data.labels[i]); }
      const oX = X(o), cX = X(c);
      ctx.save();
      if(oX!==null && cX!==null){
        ctx.fillStyle='rgba(241,196,15,0.12)';
        ctx.fillRect(Math.min(oX,cX), chartArea.top, Math.abs(oX - cX), chartArea.bottom-chartArea.top);
      }
      ctx.restore();
      ctx.save();
      if(oX!==null){ ctx.strokeStyle='rgba(241,196,15,0.95)'; ctx.setLineDash([6,4]); ctx.beginPath(); ctx.moveTo(oX,chartArea.top); ctx.lineTo(oX,chartArea.bottom); ctx.stroke(); }
      if(cX!==null){ ctx.strokeStyle='rgba(231,76,60,0.95)'; ctx.setLineDash([]); ctx.beginPath(); ctx.moveTo(cX,chartArea.top); ctx.lineTo(cX,chartArea.bottom); ctx.stroke(); }
      ctx.restore();
    }
  };
  Chart.register(customOverlayPlugin);

  const chart = new Chart(ctx,{
    type:'line',
    data:{ labels:[], datasets:[{ label:'Harga', data:[], borderColor:'#2ecc71', backgroundColor:'rgba(46,204,113,0.06)', pointRadius:0, tension:0.28, borderWidth:2 }] },
    options:{ animation:false, responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{display:false}, customOverlay:{ openIndex:null, closeIndex:null } },
      scales:{ x:{ ticks:{display:false}, grid:{color:'#222'} }, y:{ ticks:{color:'#9aa0a6'}, grid:{color:'#222'} } }
    }
  });

  function getBaseMinute(){ const m=new Date().getMinutes(); return hargaPerMenit[(m===0?59:m-1)]; }
  function getHargaDetik(){ return +(getBaseMinute() + (Math.random()-0.5)*0.03); }

  // sound off by default
  let audioCtx=null, soundEnabled=false;
  soundToggle.addEventListener('click', ()=>{ soundEnabled = !soundEnabled; soundToggle.textContent = soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡'; });

  function playTick(){
    if(!soundEnabled) return;
    try{
      if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type='sine'; o.frequency.setValueAtTime(1000,audioCtx.currentTime);
      g.gain.setValueAtTime(0.0001,audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.06,audioCtx.currentTime+0.01);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.12);
      o.stop(audioCtx.currentTime+0.15);
    }catch(e){}
  }

  let labelCounter=0;
  function pushPoint(h){
    chart.data.labels.push(labelCounter++);
    chart.data.datasets[0].data.push(h);
    if(chart.data.labels.length>120){ chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
    chart.update('none');
  }

  // periodic add point every second
  setInterval(()=>{ const h = getHargaDetik(); txtNow.textContent = h.toFixed(3); pushPoint(h); playTick(); }, 1000);

  // smooth animation for forced final
  let smoothTarget = null, smoothStartPrice = null, smoothStartTime = 0;
  const smoothDurationMs = 1800;
  function startSmoothLoss(finalPrice){
    if(!chart.data.datasets[0].data.length) return;
    smoothTarget = finalPrice;
    smoothStartPrice = chart.data.datasets[0].data[chart.data.datasets[0].data.length-1];
    smoothStartTime = performance.now();
    requestAnimationFrame(animateSmooth);
  }
  function animateSmooth(now){
    if(smoothTarget === null) return;
    const elapsed = now - smoothStartTime;
    const t = Math.min(1, Math.max(0, elapsed / smoothDurationMs));
    const ease = 1 - Math.pow(1 - t, 3);
    const newPrice = smoothStartPrice + (smoothTarget - smoothStartPrice) * ease;
    const lastIdx = chart.data.datasets[0].data.length - 1;
    if(lastIdx >= 0){ chart.data.datasets[0].data[lastIdx] = newPrice; chart.update('none'); }
    if(t < 1) requestAnimationFrame(animateSmooth); else smoothTarget = null;
  }

  function forceLoss(dir){
    const cur = chart.data.datasets[0].data.slice(-1)[0] || getBaseMinute();
    let final; const offset = 0.03 + Math.random()*0.04;
    if(dir === 'naik') final = (openPrice != null ? openPrice : cur) - offset;
    else final = (openPrice != null ? openPrice : cur) + offset;
    startSmoothLoss(final);
    return final;
  }

  /* LOGIKA TRADING (tidak berubah) */
  let tradingActive=false, openPrice=null, openIndex=null, closeIndex=null, countdown=60, timer=null, chosenAmount=0;
  function pickAmount(){ const q = Number(quickAmount.value || 0); const m = Number(manualAmount.value || 0); return m>0?m:(q>0?q:0); }
  function setDisabled(x){ btnUp.disabled = x; btnDown.disabled = x; quickAmount.disabled = x; manualAmount.disabled = x; intervalSelect.disabled = x; }

  async function startTrade(dir){
    if(tradingActive) { console.error('Transaksi masih berjalan'); return; }
    if(!currentUser) { console.error('Silakan login terlebih dahulu.'); return; }
    chosenAmount = pickAmount();
    if(!chosenAmount) { console.error('Nominal belum dipilih'); return; }
    if(chosenAmount>saldo) { console.error('Saldo tidak cukup'); return; }

    const last = chart.data.datasets[0].data.slice(-1)[0];
    openPrice = last; openIndex = chart.data.labels.length - 1; closeIndex = null;
    chart.options.plugins.customOverlay.openIndex = openIndex; chart.options.plugins.customOverlay.closeIndex = null; chart.update();

    txtOpen.textContent = openPrice ? openPrice.toFixed(3) : '-';
    txtClose.textContent = '-';
    setDisabled(true);
    countdown = Number(intervalSelect.value) * 60;
    txtCountdown.textContent = countdown;
    tradingActive = true;
    statusBox.classList.remove('result-win','result-lose'); statusBox.textContent = 'NETRAL';

    timer = setInterval(async ()=>{
      countdown--; txtCountdown.textContent = countdown;
      const current = chart.data.datasets[0].data.slice(-1)[0];
      let interim = 'NETRAL';
      if(dir === 'naik') interim = current > openPrice ? 'MENANG' : (current < openPrice ? 'KALAH' : 'NETRAL');
      else interim = current < openPrice ? 'MENANG' : (current > openPrice ? 'KALAH' : 'NETRAL');
      statusBox.classList.remove('result-win','result-lose');
      if(interim === 'MENANG'){ statusBox.textContent = 'MENANG'; statusBox.classList.add('result-win'); }
      else if(interim === 'KALAH'){ statusBox.textContent = 'KALAH'; statusBox.classList.add('result-lose'); }
      else { statusBox.textContent = 'NETRAL'; }

      if(countdown <= 0){
        clearInterval(timer); timer = null;
        const final = forceLoss(dir);
        saldo -= chosenAmount;
        
        statusBox.classList.remove('result-win'); statusBox.classList.add('result-lose');
        statusBox.textContent = `KALAH -${formatIDR(chosenAmount)} â€” Tutup @${final.toFixed(3)}`;
        lastResult.textContent = 'KALAH';
        saldoText.textContent = formatIDR(saldo);
        txtClose.textContent = final.toFixed(3);
        closeIndex = chart.data.labels.length - 1;
        chart.options.plugins.customOverlay.closeIndex = closeIndex;
        chart.update();
        tradingActive = false;
        setDisabled(false);

        // simpan saldo ke server (via API)
        if(currentUser){
          try {
            const res = await apiPost({ action: 'updateSaldo', username: currentUser, saldo: saldo });
            if(res && res.status !== 'success') console.error('Gagal update saldo di server:', res.pesan);
          } catch (e) {
            console.error('API Error saat update saldo:', e.message);
          }
        }
      }
    },1000);
  }

  btnUp.addEventListener('click', ()=>startTrade('naik'));
  btnDown.addEventListener('click', ()=>startTrade('turun'));
  quickAmount.addEventListener('change', e=>{ manualAmount.value = e.target.value; });

  /* TIMELINE */
  function pad(n){ return n.toString().padStart(2,'0'); }
  function formatHM(d){ return pad(d.getHours()) + ':' + pad(d.getMinutes()); }
  function updateTimeLine(){
    const now = new Date(); const container = document.getElementById('timeLine'); let html='';
    for(let i=5;i>=0;i--){ const t = new Date(now.getTime() - (i * 60000)); html += `<span>${formatHM(t)}</span>`; if(i>0) html+=''; }
    container.innerHTML = html;
  }
  updateTimeLine(); setInterval(updateTimeLine,1000);

  // ------------ INTERAKSI LOGIN / SERVER ------------
  function showErrorLogin(msg){ loginError.style.display = 'block'; loginError.textContent = msg; }
  function hideErrorLogin(){ loginError.style.display = 'none'; }
  function showErrorRegister(msg){ regError.style.display = 'block'; regError.textContent = msg; }
  
  function setButtonState(btn, isLoading, text){
      btn.disabled = isLoading;
      if(text) btn.textContent = isLoading ? 'LOADING...' : text;
  }
  
  async function startPolling(){
    stopPolling();
    pollIntervalId = setInterval(async ()=> {
      if(!currentUser) return;
      try{
        const res = await apiPost({ action: 'getUserData', username: currentUser });
        if(res && res.status === 'success'){
          const newSaldo = Number(res.saldo) || 0;
          if(newSaldo !== saldo){ saldo = newSaldo; saldoText.textContent = formatIDR(saldo); }
        } else if (res && res.status === 'failed') {
            window.logout(); 
        }
      } catch(e) {
          console.error("Polling Error:", e.message);
      }
    }, POLL_INTERVAL_MS);
  }
  function stopPolling(){ if(pollIntervalId){ clearInterval(pollIntervalId); pollIntervalId = null; } }

  // handler login menggunakan API POST -> action: login
  async function loginUser(){
    hideErrorLogin();
    const username = (loginUserInput.value || '').trim();
    const password = (loginPassInput.value || '').trim();
    if(!username || !password){ showErrorLogin('Isi username dan password.'); return; }
    
    setButtonState(btnLogin, true, 'LOGIN');
    setButtonState(btnOpenRegister, true, 'REGISTER');
    
    try {
        const res = await apiPost({ action: 'login', username, password });
        
        if(res && res.status === 'success'){
          currentUser = res.username || username;
          saldo = Number(res.saldo) || 0;
          saldoText.textContent = formatIDR(saldo);
          try{ localStorage.setItem('tredio_user', currentUser); }catch(e){}
          loginScreen.style.display = 'none'; mainApp.style.display = 'flex';
          startPolling();
        } else {
          showErrorLogin(res && res.pesan ? res.pesan : 'Login gagal. Cek kredensial Anda.');
        }
    } catch (e) {
        showErrorLogin(`Gagal Koneksi API: ${e.message}`);
    } finally {
        setButtonState(btnLogin, false, 'LOGIN');
        setButtonState(btnOpenRegister, false, 'REGISTER');
    }
  }
  btnLogin.addEventListener('click', loginUser);

  // Auto-login saat load
  async function attemptAutoLogin() {
    try{
      const saved = localStorage.getItem('tredio_user');
      if(saved){
        setButtonState(btnLogin, true, 'LOGIN');
        setButtonState(btnOpenRegister, true, 'REGISTER');

        const res = await apiPost({ action: 'getUserData', username: saved });

        setButtonState(btnLogin, false, 'LOGIN');
        setButtonState(btnOpenRegister, false, 'REGISTER');
        
        if(res && res.status === 'success'){
          currentUser = saved;
          saldo = Number(res.saldo) || 0;
          saldoText.textContent = formatIDR(saldo);
          loginScreen.style.display = 'none'; mainApp.style.display = 'flex';
          startPolling();
        } else {
          currentUser = null; localStorage.removeItem('tredio_user');
        }
      }
    }catch(e){ 
      console.warn('autologin error', e.message); 
      showErrorLogin(`Gagal Koneksi API saat Auto-Login: ${e.message}`);
      setButtonState(btnLogin, false, 'LOGIN');
      setButtonState(btnOpenRegister, false, 'REGISTER');
    }
  }
  attemptAutoLogin();

  // Logika REGISTER
  btnOpenRegister.addEventListener('click', ()=>{ registerPopup.style.display = 'flex'; regError.style.display = 'none'; });
  btnRegCancel.addEventListener('click', ()=>{ registerPopup.style.display = 'none'; });

  btnRegister.addEventListener('click', async ()=>{
    const u = (document.getElementById('regUser').value || '').trim();
    const p = (document.getElementById('regPass').value || '').trim();
    const e = (document.getElementById('regEmail').value || '').trim();
    const h = (document.getElementById('regHp').value || '').trim();
    const b = (document.getElementById('regBank').value || '').trim();
    const n = (document.getElementById('regNorek').value || '').trim();
    
    if(!u || !p){ showErrorRegister('Username dan Password wajib diisi.'); return; }
    
    setButtonState(btnRegister, true, 'DAFTAR');

    try {
        const res = await apiPost({ action: 'register', username: u, password: p, email: e, hp: h, bank: b, norek: n });
        
        if(res && res.status === 'success'){
          registerPopup.style.display = 'none';
          console.log('Registrasi berhasil. Saldo awal telah diisikan. Silakan login.');
          document.getElementById('loginUser').value = u; 
          document.getElementById('loginPass').value = p; 
          hideErrorLogin();
          document.getElementById('regUser').value = '';
          document.getElementById('regPass').value = '';
          document.getElementById('regEmail').value = '';
          document.getElementById('regHp').value = '';
          document.getElementById('regBank').value = '';
          document.getElementById('regNorek').value = '';
        } else {
          showErrorRegister(res && res.pesan ? res.pesan : 'Gagal registrasi. Coba username lain.');
        }
    } catch (e) {
        showErrorRegister(`Gagal Koneksi API: ${e.message}`);
    } finally {
        setButtonState(btnRegister, false, 'DAFTAR');
    }
  });

  // Logout helper
  window.logout = function(){ 
      try{ localStorage.removeItem('tredio_user'); }catch(e){} 
      stopPolling(); 
      currentUser = null; 
      mainApp.style.display = 'none'; 
      loginScreen.style.display = 'flex'; 
      hideErrorLogin();
      document.getElementById('loginUser').value = '';
      document.getElementById('loginPass').value = '';
  };

});
</script>
</body>
</html>
